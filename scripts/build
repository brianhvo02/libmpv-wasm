#!/bin/sh

set -e

if ! [ -f "node_modules/typescript/bin/tsc" ]; then
    echo "tsc command not found"
    exit 1
fi

COUNT=$(find shaders -type f | wc -l)

if [ -n $DOCKER_BUILD ]; then
    if [ "$COUNT" -eq 1 ]; then
        docker run --rm -v .:/app -w /app -u "$(id -u):$(id -g)" brianhvo02/em_mpv:latest scripts/dl_a4k_shaders
    fi
    docker run --rm -v .:/app -w /app -u "$(id -u):$(id -g)" brianhvo02/em_mpv:latest scripts/rebuild
else
    if [ "$COUNT" -eq 1 ]; then
        scripts/dl_a4k_shaders
    fi
    scripts/rebuild
fi

tsc
cat src/types/libmpv.d.ts >> build/libmpv.d.ts
cat src/types/index.d.ts >> build/index.d.ts

if ! [ -d "demo/node_modules/libmpv-wasm" ]; then
    scripts/link
fi